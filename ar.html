<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>AR — Konfigurator</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/favicon.png" />
  <style>
    html, body { height:100%; margin:0; background:#000; font-family: Arial, sans-serif; }
    #xr-loading { 
      position: fixed; inset: 0; z-index: 3001; 
      display: flex; align-items: center; justify-content: center; 
      background: rgba(0,0,0,0.45); 
    }
    #xr-loading .inner { display: flex; flex-direction: column; align-items: center; }
    #xr-loading .spinner { 
      width: 48px; height: 48px; border-radius: 50%; 
      border: 4px solid rgba(255,255,255,0.25); 
      border-top-color: #fff; 
      animation: xrspin 1s linear infinite; 
    }
    #xr-loading p { color: #fff; margin-top: 12px; font-size: 14px; }
    @keyframes xrspin { to { transform: rotate(360deg); } }
    
    #xr-exit-btn { 
      position: fixed; bottom: 20px; right: 20px; z-index: 3002; 
      background: rgba(0,0,0,0.65); color: #fff; border: 0; 
      border-radius: 10px; padding: 12px 16px; font-size: 14px; 
      display: none; 
    }
    
    #xr-reticle-2d { 
      position: fixed; left: 50%; top: 50%; 
      width: 40px; height: 40px; margin: -20px 0 0 -20px; 
      z-index: 3001; border-radius: 50%; 
      border: 2px solid rgba(255,215,0,0.9); 
      box-shadow: 0 0 8px rgba(255,215,0,0.6); 
      display: none; pointer-events: none; 
    }
    
    #ar-unsupported { 
      position: fixed; inset: 0; display: none; 
      align-items: center; justify-content: center; 
      background: #000; color:#fff; z-index: 3003; 
      text-align:center; padding: 20px; 
    }
    #ar-unsupported a { color:#fff; text-decoration: underline; }
    
    #ar-ui { 
      position: fixed; left: 0; right: 0; bottom: 0; z-index: 3004; 
      display: flex; gap: 8px; padding: 10px; justify-content: center; 
      background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.55) 35%); 
    }
    #ar-ui button { 
      background: rgba(0,0,0,0.65); color:#fff; border:0; 
      border-radius: 10px; padding:10px 12px; font-size: 14px; 
    }

    /* Mini konfigurator w AR (MVP: wybór modelu) */
    #config-toggle {
      position: fixed; top: 16px; left: 16px; z-index: 3005;
      background: rgba(0,0,0,0.65); color:#fff; border: 0; border-radius: 10px;
      padding: 10px 12px; font-size: 14px;
    }
    #config-panel {
      position: fixed; top: 16px; left: 16px; z-index: 3006;
      width: 320px; max-height: 70vh; overflow: auto; display: none;
      background: rgba(20,20,20,0.92); color: #fff; border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4); padding: 12px;
    }
    #config-panel h4 { margin: 0 0 8px 0; font-size: 16px; }
    #config-search { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #333; background:#111; color:#fff; }
    #config-list { margin-top: 10px; display: grid; grid-template-columns: 1fr; gap: 6px; }
    .cfg-item { display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 8px; background:#141414; border: 1px solid #333; cursor: pointer; }
    .cfg-item:hover { background:#1e1e1e; }
    .cfg-item img { width: 40px; height: 40px; object-fit: contain; border-radius: 6px; background:#000; }
    .cfg-item .name { font-size: 14px; font-weight: 600; color:#fff; }
    .cfg-close { position:absolute; top:8px; right:10px; background:none; border:0; color:#bbb; font-size:20px; cursor:pointer; }

    /* Diagnostics (optional) */
    #ar-diagnostics { position: fixed; bottom: 70px; left: 10px; z-index: 3004; color:#ddd; font-size: 12px; opacity: 0.85; }
  </style>
</head>
<body>
  <div id="xr-loading">
    <div class="inner">
      <div class="spinner"></div>
      <p>Uruchamianie AR…</p>
    </div>
  </div>
  
  <div id="xr-reticle-2d"></div>
  <button id="xr-exit-btn">Zakończ AR</button>
  
  <div id="ar-unsupported">
    <div>
  <h3>AR nie jest dostępne</h3>
  <p>Ta przeglądarka nie wspiera WebXR AR.</p>
  <p>Na iOS włącz WebXR w Safari → Advanced → Experimental Features.</p>
      <p>
        <button id="open-native-ar" style="display:none; background:#1e88e5;color:#fff;border:0;border-radius:10px;padding:10px 14px;">
          Otwórz w trybie natywnym
        </button>
      </p>
  <p><a href="index.html">Wróć do konfiguratora</a></p>
    </div>
  </div>
  
  <div id="ar-ui" style="display:none">
  <button id="btn-rotate">Obróć 15°</button>
    <button id="btn-scale-up">Skaluj +</button>
    <button id="btn-scale-down">Skaluj -</button>
  </div>

  <button id="config-toggle">Konfiguracja</button>
  <div id="config-panel">
    <button class="cfg-close" id="cfg-close" title="Zamknij">×</button>
    <h4>Wybierz model</h4>
    <input id="config-search" placeholder="Szukaj…" />
    <div id="config-list"></div>
  </div>

  <div id="ar-diagnostics" style="display:none"></div>

  <!-- Hidden Quick Look launcher for iOS (auto-clicked to skip white poster UI) -->
  <a id="ql-link" rel="ar" href="#" style="display:none">
    <img id="ql-poster" src="icons/AR_icon.png" alt="poster" />
  </a>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.157.0/build/three.module.js';
  import { GLTFLoader } from 'https://unpkg.com/three@0.157.0/examples/jsm/loaders/GLTFLoader.js';
  import { USDZLoader } from 'https://unpkg.com/three@0.157.0/examples/jsm/loaders/USDZLoader.js';

  console.log('AR.html z WebXR uruchamia się...');

  // Pobierz model z URL lub localStorage
    const url = new URL(window.location.href);
    const paramModel = url.searchParams.get('model');
    let modelUrl = paramModel || localStorage.getItem('ar:lastModel') || 'chairs/Tulla-2.glb';
  // Ustal platformę (tylko do diagnostyki i ewentualnych obejść)
  const ua = navigator.userAgent || '';
  const isAndroid = /Android/i.test(ua);
  const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
  const isMobile = isAndroid || isIOS;
    
    try { 
      localStorage.setItem('ar:lastModel', modelUrl); 
    } catch(e) { 
      console.warn('localStorage niedostpny'); 
    }

  console.log('Ładowanie modelu:', modelUrl);

    // Setup Three.js z WebXR
    const renderer = new THREE.WebGLRenderer({ 
      antialias: true, 
      alpha: true, 
      powerPreference: 'high-performance' 
    });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    
  // Włączenie WebXR
    renderer.xr.enabled = true;
    
    document.body.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.01, 50);
    
    // Dodaj podstawowe owietlenie
    scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.0));
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
    dirLight.position.set(1, 1, 1);
    scene.add(dirLight);

    // Elementy UI
    const loading = document.getElementById('xr-loading');
    const exitBtn = document.getElementById('xr-exit-btn');
    const reticle = document.getElementById('xr-reticle-2d');
    const unsupported = document.getElementById('ar-unsupported');
    const nativeBtn = document.getElementById('open-native-ar');
    const arUI = document.getElementById('ar-ui');
    const btnRotate = document.getElementById('btn-rotate');
    const btnScaleUp = document.getElementById('btn-scale-up');
    const btnScaleDown = document.getElementById('btn-scale-down');

    // Stan AR
    let xrState = { 
      session: null, 
      refSpace: null, 
      hitTestSource: null, 
      placed: false, 
      model: null 
    };

    // Loadery
    const gltfLoader = new GLTFLoader();
    const usdzLoader = new USDZLoader();
    
  async function loadModel(uri) {
      return new Promise((resolve, reject) => {
    const src = encodeURI(uri);
    console.log('Ładowanie modelu:', src);
    const isUSDZ = /\.usdz$/i.test(src);
        if (isUSDZ) {
          console.log('Wykryto USDZ — używam USDZLoader');
          usdzLoader.load(
      src,
            (group) => {
              const root = group;
              // Podstawowa optymalizacja
              root.traverse((child) => {
                if (child.isMesh) { child.castShadow = false; child.receiveShadow = false; }
              });
              if (root.scale.length() < 0.001) root.scale.setScalar(0.01);
              console.log('USDZ załadowany pomyślnie');
              resolve(root);
            },
            (progress) => { /* brak standaryzowanego progressu dla USDZ */ },
            (error) => {
              console.error('Błąd ładowania USDZ:', error);
              reject(error);
            }
          );
        } else {
          gltfLoader.load(
            src,
            (gltf) => {
              const root = gltf.scene || gltf.scenes?.[0];
              if (!root) { reject(new Error('Brak sceny w GLB')); return; }
              root.traverse((child) => { if (child.isMesh) { child.castShadow = false; child.receiveShadow = false; } });
              if (root.scale.length() < 0.001) root.scale.setScalar(0.01);
              console.log('GLB załadowany pomyślnie');
              resolve(root);
            },
            (progress) => { console.log('Postęp ładowania:', Math.round(progress.loaded / (progress.total||1) * 100) + '%'); },
            (error) => { console.error('Błąd ładowania GLB:', error); reject(error); }
          );
        }
      });
    }

    // Obsuga zmiany rozmiaru okna
    function onResize() {
      const w = window.innerWidth;
      const h = window.innerHeight;
      renderer.setSize(w, h);
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
    }
    window.addEventListener('resize', onResize, { passive: true });

  // Główna funkcja AR z WebXR
    async function startAR() {
      try {
        loading.style.display = 'flex';
  console.log('Uruchamianie AR z WebXR...');

  // Sprawdź wsparcie WebXR (iOS i Android)
  const supported = !!(navigator.xr && await navigator.xr.isSessionSupported?.('immersive-ar'));
        
        if (!supported) {
          console.log('WebXR AR nie jest wspierany, pokazuję fallback');
          loading.style.display = 'none';
          unsupported.style.display = 'flex';
          
          // Setup natywny AR fallback (ostatnia deska ratunku)
          if (nativeBtn) {
            if (isAndroid) {
              // Android Scene Viewer
              const title = encodeURIComponent(modelUrl.split('/').pop() || 'Model');
              const fileAbs = encodeURIComponent(new URL(modelUrl, window.location.href).toString());
              const sceneViewerUrl = `https://arvr.google.com/scene-viewer/1.0?file=${fileAbs}&mode=ar_only&title=${title}`;
              
              nativeBtn.style.display = 'inline-block';
              nativeBtn.onclick = () => { 
                window.location.href = sceneViewerUrl; 
              };
            } else if (isIOS) {
              // iOS: Quick Look fallback, jeśli istnieje USDZ
              const usdz = await resolveUsdzCandidate(modelUrl);
              if (usdz) {
                nativeBtn.style.display = 'inline-block';
                nativeBtn.onclick = () => { window.location.href = new URL(usdz, window.location.href).toString(); };
              }
            }
          }
          return;
        }

    // Wstępnie załaduj model (.glb lub .usdz) — WebXR uruchamiamy na obu platformach
        let modelRoot = null;
        try {
          modelRoot = await loadModel(modelUrl);
        } catch(e) {
          console.error('Nie udało się załadować modelu dla WebXR:', e);
          // Jeśli próbujemy USDZ i padło – spróbuj automatycznie GLB o tej samej bazie nazwy
          try {
            const base = modelUrl.replace(/\.usdz$/i, '').replace(/\.(glb|gltf)$/i,'');
            const alt = `${base}.glb`;
            console.log('Próba alternatywy GLB:', alt);
            modelRoot = await loadModel(alt);
          } catch(e2) {
            console.error('Alternatywa GLB też nie działa:', e2);
          // Spróbuj natywnego AR jako awaryjne rozwiązanie
          loading.style.display = 'none';
          unsupported.style.display = 'flex';
          if (nativeBtn) {
            if (isAndroid) {
              const title = encodeURIComponent(modelUrl.split('/').pop() || 'Model');
              const fileAbs = encodeURIComponent(new URL(modelUrl.replace(/\.usdz$/i,'.glb'), window.location.href).toString());
              const sceneViewerUrl = `https://arvr.google.com/scene-viewer/1.0?file=${fileAbs}&mode=ar_only&title=${title}`;
              nativeBtn.style.display = 'inline-block';
              nativeBtn.onclick = () => { window.location.href = sceneViewerUrl; };
            } else if (isIOS) {
              const base = modelUrl.replace(/\.glb$/i, '');
              const candidates = [ `${base}.usdz`, `${base}-2.usdz`, `${base.replace(/\s+/g,'_')}.usdz`, `chairs/Tulla-2.usdz` ];
              let chosen = null;
              for (const candidate of candidates) {
                try { const res = await fetch(candidate, { method: 'HEAD' }); if (res.ok) { chosen = candidate; break; } } catch(_) {}
              }
              if (chosen) {
                nativeBtn.style.display = 'inline-block';
                nativeBtn.onclick = () => { window.location.href = new URL(chosen, window.location.href).toString(); };
              }
            }
          }
          return;
          }
        }

  // Utworzenie sesji AR WebXR
  console.log('Tworzenie sesji WebXR AR...');
        const session = await navigator.xr.requestSession('immersive-ar', {
          requiredFeatures: ['hit-test', 'local'],
          optionalFeatures: ['local-floor', 'dom-overlay'],
          domOverlay: { root: document.body }
        });
        
        xrState.session = session;
        await renderer.xr.setSession(session);

  console.log('Sesja WebXR AR uruchomiona!');

        // Poka UI AR
        exitBtn.style.display = 'block';
        reticle.style.display = 'block';
        arUI.style.display = 'flex';
        
        // Setup obsugi wyjcia
        exitBtn.onclick = endAR;

        // Setup przestrzeni referencyjnych
        const refSpace = await session.requestReferenceSpace('local-floor');
        xrState.refSpace = refSpace;
        
        const viewerSpace = await session.requestReferenceSpace('viewer');
        xrState.hitTestSource = await session.requestHitTestSource?.({ 
          space: viewerSpace 
        });

        // Event listenery
        session.addEventListener('end', () => { endAR(); });
        session.addEventListener('select', () => { 
          console.log('Select event - umieszczanie modelu');
          xrState.placed = true; 
        });

        // Setup kontrolek UI
        btnRotate.onclick = () => {
          if (xrState.model) {
            xrState.model.rotateY(THREE.MathUtils.degToRad(15));
            console.log('Obrócono model o 15 stopni');
          }
        };
        
        btnScaleUp.onclick = () => {
          if (xrState.model) {
            xrState.model.scale.multiplyScalar(1.1);
            console.log('Powiększono model');
          }
        };
        
        btnScaleDown.onclick = () => {
          if (xrState.model) {
            xrState.model.scale.multiplyScalar(0.9);
            console.log('Pomniejszono model');
          }
        };

  // Pętla renderowania z hit-test
        renderer.setAnimationLoop((timestamp, frame) => {
          if (!frame) return;
          
          const pose = frame.getViewerPose(refSpace);
          if (!pose) return;
          
          // Hit testing - wykrywanie powierzchni
          if (xrState.hitTestSource) {
            const results = frame.getHitTestResults(xrState.hitTestSource);
            if (results && results.length > 0) {
              const hit = results[0];
              const hitPose = hit.getPose(refSpace);
              
              if (hitPose && xrState.placed) {
                // Umie/zaktualizuj model na pozycji hit
                if (!xrState.model && modelRoot) {
                  xrState.model = modelRoot;
                  scene.add(modelRoot);
                  console.log('Model dodany do sceny');
                }
                
                if (xrState.model) {
                  const matrix = new THREE.Matrix4().fromArray(hitPose.transform.matrix);
                  xrState.model.matrixAutoUpdate = false;
                  xrState.model.matrix.copy(matrix);
                  xrState.model.updateMatrixWorld(true);
                }
              }
            }
          }
          
          renderer.render(scene, camera);
        });

        loading.style.display = 'none';
  console.log('WebXR AR sesja uruchomiona pomyślnie!');
        
      } catch(error) {
  console.error('Błąd uruchamiania AR:', error);
        loading.style.display = 'none';
        alert('Nie udało się uruchomić AR: ' + error.message);
      }
    }

    // Zakończ sesję AR
    async function endAR() {
      console.log('Kończenie sesji AR...');
      
      try {
        loading.style.display = 'none';
        exitBtn.style.display = 'none';
        reticle.style.display = 'none';
        arUI.style.display = 'none';
      } catch(e) {}
      
      try {
        renderer.setAnimationLoop(null);
      } catch(e) {}
      
      if (xrState.session) {
        try {
          await xrState.session.end();
        } catch(e) {
          console.warn('Bd koczenia sesji:', e);
        }
      }
      
      // Reset stanu
      xrState = { 
        session: null, 
        refSpace: null, 
        hitTestSource: null, 
        placed: false, 
        model: null 
      };
      
      // Nawiguj z powrotem
      try {
        if (history.length > 1) {
          history.back();
        } else {
          window.location.assign('index.html');
        }
      } catch(e) {
        window.location.href = 'index.html';
      }
    }

    // ?? Auto-start AR gdy strona si aduje
    startAR();

    // ===== Mini konfigurator (MVP: wybór modelu) =====
    const cfgToggle = document.getElementById('config-toggle');
    const cfgPanel = document.getElementById('config-panel');
    const cfgClose = document.getElementById('cfg-close');
    const cfgSearch = document.getElementById('config-search');
    const cfgList = document.getElementById('config-list');
    const diag = document.getElementById('ar-diagnostics');

    function setDiagnostics(text) {
      if (!diag) return;
      diag.style.display = 'block';
      diag.textContent = text;
    }

    cfgToggle?.addEventListener('click', () => {
      cfgPanel.style.display = cfgPanel.style.display === 'none' || cfgPanel.style.display === '' ? 'block' : 'none';
    });
    cfgClose?.addEventListener('click', () => { cfgPanel.style.display = 'none'; });

    const SHEET_ID = '1ftI8CkA2Itav_h45KOap__JYtup28V1FiBmpP0p_Cjc';
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Baza Danych`;
    let sheetData = [];

    async function loadSheet() {
      try {
        const res = await fetch(SHEET_URL + '&v=' + Date.now(), { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const csv = await res.text();
        const rows = csv.trim().split('\n');
        const headers = (rows.shift() || '').match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g).map(h=>h.replace(/"/g,'').trim());
        sheetData = rows.map(r => {
          const vals = r.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
          const o = {}; headers.forEach((h,i)=> o[h] = (vals[i]||'').replace(/"/g,'').trim()); return o;
        }).filter(it => (it.Visible||'').toLowerCase() !== 'false');
        renderList('');
      } catch(e) {
        console.warn('Nie udało się wczytać arkusza do AR UI:', e);
      }
    }

    function renderList(filter) {
      if (!cfgList) return;
      cfgList.innerHTML = '';
      const q = (filter||'').toLowerCase();
      const models = sheetData.filter(it => (it.Typ||'').toLowerCase()==='model' && (!q || (it.Nazwa||'').toLowerCase().includes(q)));
      models.slice(0,100).forEach(m => {
        const div = document.createElement('div');
        div.className = 'cfg-item';
        const img = document.createElement('img'); img.src = m.Obrazek || 'icons/AR_icon.png'; img.alt = m.Nazwa||''; div.appendChild(img);
        const name = document.createElement('div'); name.className='name'; name.textContent = m.Nazwa || ''; div.appendChild(name);
        div.onclick = () => chooseModel(m.Nazwa);
        cfgList.appendChild(div);
      });
    }

    cfgSearch?.addEventListener('input', e => renderList(e.target.value));
    loadSheet();

    async function headOk(p) {
      try {
        const abs = new URL(p, window.location.href).toString();
        const r= await fetch(abs,{method:'HEAD'});
        return r.ok;
      } catch { return false; }
    }

    async function resolveUsdzCandidate(fromUrl) {
      // Szukaj USDZ odpowiadającego bazie nazwy
      try {
        const base = fromUrl.replace(/\.(glb|gltf|usdz)$/i,'');
        const tries = [ `${base}.usdz`, `${base}-2.usdz`, `${base.replace(/\s+/g,'_')}.usdz` ];
        for (const t of tries) { if (await headOk(t)) return t; }
      } catch {}
      return null;
    }

    async function resolvePosterForModel() {
      // Spróbuj obrazka z arkusza dla aktualnego modelu, jeśli jest dostępny; w przeciwnym razie użyj ikony AR
      const cur = (new URL(window.location.href)).searchParams.get('model') || '';
      const name = (cur.split('/').pop() || '').replace(/\.(glb|gltf|usdz)$/i,'');
      const hit = sheetData.find(it => (it.Typ||'').toLowerCase()==='model' && (it.Nazwa||'').toLowerCase()===name.toLowerCase());
      return hit?.Obrazek || 'icons/AR_icon.png';
    }

    async function openQuickLook(usdzUrl, posterUrl) {
      try {
        const link = document.getElementById('ql-link');
        const img = document.getElementById('ql-poster');
        const abs = new URL(usdzUrl, window.location.href).toString();
        // Opcje Quick Look przez fragment (część jest wspierana w nowszych iOS)
        const opts = `#allowsContentScaling=1&canonicalWebPageURL=${encodeURIComponent(window.location.href)}`;
        link.setAttribute('href', abs + opts);
        if (img && posterUrl) img.src = posterUrl;

        // Szybkie kliknięcie, aby ominąć biały ekran i domyślne przyciski
        setTimeout(() => {
          try { link.click(); } catch {}
        }, 50);

        // Diagnostyka: obserwuj widoczność, aby wiedzieć, kiedy AR się otwiera/zamyka
        document.addEventListener('visibilitychange', () => {
          if (document.hidden) {
            // AR Quick Look otwarty
            setDiagnostics('Quick Look otwarty');
          } else {
            // Quick Look zamknięty
            setDiagnostics('Quick Look zamknięty');
          }
        }, { once: true });
      } catch(e) {
        console.warn('Nie udało się otworzyć Quick Look:', e);
      }
    }

    async function chooseModel(name) {
      // Zbuduj listę kandydatów jak w index.html, zależnie od platformy
      const norm = (s)=> s.normalize?.('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^\w\s-]/g,'').trim();
      const bases = Array.from(new Set([
        name,
        norm(name),
        norm(name).replace(/\s+/g,' '),
        norm(name).replace(/\s+/g,''),
        norm(name).replace(/\s+/g,'-'),
        norm(name).replace(/\s+/g,'_')
      ].filter(Boolean)));
      const dirs=['chairs','models'];
      const glbs=[]; const usdz=[];
      for (const d of dirs) { for (const b of bases) { glbs.push(`${d}/${b}.glb`, `${d}/${b}-2.glb`); usdz.push(`${d}/${b}.usdz`, `${d}/${b}-2.usdz`); } }
      if (isIOS) {
        // iOS: od razu Quick Look, bez białego UI
        for (const u of usdz) { if (await headOk(u)) { await openQuickLook(u, await resolvePosterForModel()); return; } }
        // Brak USDZ → przeładuj z GLB (WebXR fallback)
        for (const g of glbs) { if (await headOk(g)) { const next = new URL(window.location.href); next.searchParams.set('model', g); window.location.href = next.toString(); return; } }
        alert('Nie znaleziono plików dla: ' + name);
        return;
      } else {
        // Android/pozostali → GLB (WebXR)
        for (const g of glbs) { if (await headOk(g)) { const next = new URL(window.location.href); next.searchParams.set('model', g); window.location.href = next.toString(); return; } }
        // Rezerwowo spróbuj USDZ (mało prawdopodobne)
        for (const u of usdz) { if (await headOk(u)) { const next = new URL(window.location.href); next.searchParams.set('model', u); window.location.href = next.toString(); return; } }
        alert('Nie znaleziono plików dla: ' + name);
      }
    }
  </script>
</body>
</html>

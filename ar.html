<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>AR — WebXR (GLB)</title>
    <link rel="icon" href="icons/favicon.png" />
    <style>
      html, body { height:100%; margin:0; background:#000; font-family: system-ui, Arial, sans-serif; }
      canvas { display:block; position:fixed; inset:0; width:100%; height:100%; }
      #overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:12px; background: rgba(0,0,0,0.7); color:#fff; z-index: 10; }
      #overlay.hidden { display:none; }
      #startBtn { background:#F5C842; color:#333; border:0; padding:12px 16px; border-radius: 12px; font-weight:700; }
      #loading { position:fixed; top:12px; left:50%; transform:translateX(-50%); background: rgba(0,0,0,0.6); color:#fff; padding:8px 12px; border-radius:10px; z-index: 11; display:none; }
      #reticle { position:fixed; width:48px; height:48px; left:50%; top:50%; transform: translate(-50%, -50%); border:2px solid rgba(255,255,255,0.9); border-radius:50%; box-shadow: 0 0 0 8px rgba(255,255,255,0.08) inset; display:none; z-index: 5; }
      #ui { position:fixed; left:0; right:0; bottom: env(safe-area-inset-bottom, 0); display:flex; gap:10px; justify-content:center; padding: 12px calc(12px + env(safe-area-inset-right, 0)) calc(12px + env(safe-area-inset-bottom, 0)) calc(12px + env(safe-area-inset-left, 0)); z-index: 11; pointer-events: none; }
      #ui .btn { pointer-events: auto; background: rgba(0,0,0,0.6); color:#fff; border:1px solid rgba(255,255,255,0.2); padding:10px 14px; border-radius:12px; font-size:14px; }
      .back { position:fixed; top:12px; left:12px; z-index:11; background: rgba(0,0,0,0.6); color:#fff; border:0; border-radius:10px; padding:8px 12px; }
      #unsupported { position:fixed; inset:0; display:none; align-items:center; justify-content:center; text-align:center; background:rgba(0,0,0,0.8); color:#fff; padding:20px; z-index:12; }
      #unsupported.show { display:flex; }
    </style>
  </head>
  <body>
    <button class="back" id="backBtn">← Wróć</button>
    <div id="overlay">
      <img src="icons/AR_icon.png" alt="AR" width="72" height="72" style="opacity:.9"/>
      <div>Dotknij, aby uruchomić AR (WebXR)</div>
      <button id="startBtn" type="button">Uruchom AR</button>
    </div>
    <div id="loading">Ładowanie modelu… <span id="progress">0%</span></div>
    <div id="reticle" aria-hidden="true"></div>
    <div id="ui">
      <button id="reset" class="btn" type="button">Reset</button>
      <button id="repose" class="btn" type="button">Na podłodze</button>
      <button id="config" class="btn" type="button">Konfiguruj</button>
    </div>
    <div id="unsupported">
      <div>
        <h3>WebXR AR nie jest wspierane</h3>
        <p>Twoja przeglądarka/urządzenie nie obsługuje trybu AR w przeglądarce (WebXR).</p>
        <p><button id="goBack" class="btn" type="button" style="background:#F5C842;color:#333;border:0">Wróć</button></p>
      </div>
    </div>

    <script type="module">
      import * as THREE from 'https://unpkg.com/three@0.157.0/build/three.module.js';
      import { GLTFLoader } from 'https://unpkg.com/three@0.157.0/examples/jsm/loaders/GLTFLoader.js';
      import { DRACOLoader } from 'https://unpkg.com/three@0.157.0/examples/jsm/loaders/DRACOLoader.js';

      // URL params
      const url = new URL(window.location.href);
      const modelUrl = url.searchParams.get('model') || 'chairs/Tulla-2.glb';
      const retUrl = url.searchParams.get('ret') || document.referrer || 'index.html';

      // DOM
      const overlayEl = document.getElementById('overlay');
      const startBtn = document.getElementById('startBtn');
      const backBtn = document.getElementById('backBtn');
      const resetBtn = document.getElementById('reset');
      const reposeBtn = document.getElementById('repose');
      const configBtn = document.getElementById('config');
      const loadingEl = document.getElementById('loading');
      const progressEl = document.getElementById('progress');
      const reticleEl = document.getElementById('reticle');
      const unsupportedEl = document.getElementById('unsupported');
      const goBackBtn = document.getElementById('goBack');

      function goBack(){
        try { if (history.length > 1) { history.back(); return; } } catch(e){}
        window.location.assign(retUrl || 'index.html');
      }
      backBtn.addEventListener('click', (e)=>{ e.preventDefault(); goBack(); });
      goBackBtn.addEventListener('click', (e)=>{ e.preventDefault(); goBack(); });
      configBtn.addEventListener('click', (e)=>{ e.preventDefault(); goBack(); });

      // Three.js basics
      const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio||1, 2));
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      document.body.appendChild(renderer.domElement);

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.01, 100);
      const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
      scene.add(light);

      // Load model (GLB)
      const loader = new GLTFLoader();
      const draco = new DRACOLoader();
      draco.setDecoderPath('https://unpkg.com/three@0.157.0/examples/jsm/libs/draco/');
      loader.setDRACOLoader(draco);

      let modelRoot = null;
      async function loadModel() {
        loadingEl.style.display = 'block';
        return new Promise((resolve, reject) => {
          loader.load(modelUrl, (gltf)=>{
            modelRoot = gltf.scene || gltf.scenes?.[0];
            if (!modelRoot) { reject(new Error('Brak sceny w GLB')); return; }
            // Normalize scale a bit
            modelRoot.traverse((o)=>{ if (o.isMesh) { o.castShadow = o.receiveShadow = false; } });
            modelRoot.visible = false; // show after placement
            scene.add(modelRoot);
            loadingEl.style.display = 'none';
            resolve();
          }, (e)=>{
            if (e && e.total) {
              const pct = Math.round(100 * e.loaded / e.total);
              progressEl.textContent = `${pct}%`;
            } else {
              progressEl.textContent = '...';
            }
          }, (err)=>{
            loadingEl.style.display = 'none';
            reject(err);
          });
        });
      }

      // XR state
      let xrSession = null;
      let refSpace = null;
      let viewerSpace = null;
      let hitTestSource = null;
      let placed = false;
      let lastHitMatrix = new THREE.Matrix4();

      function setModelMatrixFromPoseMatrix(mat){
        if (!modelRoot) return;
        modelRoot.matrixAutoUpdate = false;
        modelRoot.matrix.copy(mat);
        modelRoot.updateMatrixWorld(true);
      }

      async function startAR(){
        if (!navigator.xr || typeof navigator.xr.isSessionSupported !== 'function') {
          unsupportedEl.classList.add('show');
          return;
        }
        const supported = await navigator.xr.isSessionSupported('immersive-ar');
        if (!supported) { unsupportedEl.classList.add('show'); return; }

        await loadModel();

        overlayEl.classList.add('hidden');
        xrSession = await navigator.xr.requestSession('immersive-ar', {
          requiredFeatures: ['local-floor'],
          optionalFeatures: ['hit-test', 'dom-overlay', 'light-estimation'],
          domOverlay: { root: document.body }
        });
        renderer.xr.setReferenceSpaceType('local-floor');
        await renderer.xr.setSession(xrSession);

        refSpace = await xrSession.requestReferenceSpace('local-floor');
        viewerSpace = await xrSession.requestReferenceSpace('viewer');
        if (xrSession.requestHitTestSource) {
          hitTestSource = await xrSession.requestHitTestSource({ space: viewerSpace });
        }

        xrSession.addEventListener('end', ()=>{
          placed = false; hitTestSource = null; xrSession = null; reticleEl.style.display='none';
          goBack();
        });
        xrSession.addEventListener('select', ()=>{
          if (lastHitMatrix && modelRoot) {
            setModelMatrixFromPoseMatrix(lastHitMatrix);
            modelRoot.visible = true;
            placed = true;
            reticleEl.style.display='none';
          }
        });

        renderer.setAnimationLoop((t, frame)=>{
          if (!frame) return;
          const pose = frame.getViewerPose(refSpace);
          if (!pose) return;

          // Hit testing until placed
          if (!placed && hitTestSource) {
            const hits = frame.getHitTestResults(hitTestSource);
            if (hits && hits.length) {
              const hit = hits[0];
              const hitPose = hit.getPose(refSpace);
              if (hitPose) {
                lastHitMatrix.fromArray(hitPose.transform.matrix);
                reticleEl.style.display = 'block';
              }
            } else {
              reticleEl.style.display = 'none';
            }
          }

          renderer.render(scene, camera);
        });
      }

      // UI actions
      startBtn.addEventListener('click', ()=>{ startAR().catch(err=>{ console.error(err); unsupportedEl.classList.add('show'); }); });
      resetBtn.addEventListener('click', ()=>{
        try {
          if (!modelRoot) return;
          modelRoot.visible = false;
          modelRoot.matrixAutoUpdate = true;
          modelRoot.position.set(0,0,-1.2);
          modelRoot.rotation.set(0,0,0);
          modelRoot.scale.set(1,1,1);
          placed = false;
        } catch(e){}
      });
      reposeBtn.addEventListener('click', ()=>{ placed = false; reticleEl.style.display='block'; });

      // Resize
      window.addEventListener('resize', ()=>{
        renderer.setSize(window.innerWidth, window.innerHeight);
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
      });
    </script>
  </body>
</html>

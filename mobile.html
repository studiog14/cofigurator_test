<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="format-detection" content="telephone=no" />
    <title>Konfigurator krzeseł – Mobile</title>
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="icons/favicon.png" />
    <link rel="icon" href="favicon.png" />
    <style>
        html,body{height:100%;margin:0}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:#fff;color:#222}
        .loader{display:flex;align-items:center;justify-content:center;flex-direction:column;height:100vh;gap:12px}
        .spinner{width:40px;height:40px;border:3px solid #eee;border-top:3px solid #333;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .muted{color:#666;font-size:14px}
        .error{color:#b00020}
    </style>
    <script>
        (function(){
            // Minimal mobile-mode hint for CSS before app scripts run
            document.addEventListener('DOMContentLoaded', function(){
                try { document.body.classList.add('mobile-mode'); } catch(_) {}
            });
        })();
    </script>
</head>
<body>
        <div id="boot-loader" class="loader">
            <div class="spinner" aria-hidden="true"></div>
            <div>Ładowanie wersji mobilnej…</div>
        </div>

    <script>
        (async function(){
            const container = document.getElementById('boot-loader');
            function showError(msg){
                if(container){
                    container.innerHTML = '<div class="error">'+ (msg||'Błąd ładowania') +'</div>' +
                        '<div class="muted">Spróbuj ponownie, lub otwórz wersję standardową: <a href="index.html">index.html</a></div>';
                }
            }

            try {
                // Pobierz źródło index.html i przygotuj wersję z shimami dla iOS
                const res = await fetch('index.html', { credentials: 'same-origin' });
                if(!res.ok){ throw new Error('HTTP '+res.status); }
                let html = await res.text();

                    // Prosty transpiler usuwający optional chaining / nullish coalescing w inline module script
                    function transpileLight(src){
                        // iOS 15 wspiera optional chaining; unikamy ryzykownych podmian regex.
                        return src;
                    }

                // 1) Wstrzyknij es-module-shims w <head> (lub zaraz po <meta charset>)
                const shimTag = '<script async src="https://cdn.jsdelivr.net/npm/es-module-shims@1/dist/es-module-shims.min.js"></' + 'script>';
                if(html.includes('</head>')){
                    html = html.replace(/<head[^>]*>/i, function(m){ return m + '\n  ' + shimTag + '\n'; });
                } else {
                    // awaryjnie dodaj na początku
                    html = shimTag + '\n' + html;
                }

                // 2) Konwersja import map i modułów na wariant shim
                html = html
                    .replace(/type="importmap"/g, 'type="importmap-shim"')
                    .replace(/type="module"/g, 'type="module-shim"');

                    // 2b) Przetranskrybuj inline module-shim scripts (bez dotykania zewnętrznych plików)
                    html = html.replace(/<script([^>]*type=\"module-shim\"[^>]*)>([\s\S]*?)<\/script>/gi, function(_, attrs, code){
                        try {
                        let patched = transpileLight(code);
                        // Dodatkowe mobilne gardy na brakujące elementy DOM
                        patched = patched.replace(/buyButton\.addEventListener\(/g, 'buyButton && buyButton.addEventListener(');
                        patched = patched.replace(/closeBtn\.addEventListener\(/g, 'closeBtn && closeBtn.addEventListener(');
                        patched = patched.replace(/emailModal\.addEventListener\(/g, 'emailModal && emailModal.addEventListener(');
                        patched = patched.replace(/emailForm\.addEventListener\(/g, 'emailForm && emailForm.addEventListener(');
                            return '<script'+attrs+'>'+patched+'<\/script>';
                        } catch(e) {
                            return '<script'+attrs+'>'+code+'<\/script>';
                        }
                    });

                // 2c) Odłóż ładowanie zewnętrznych CDN scriptów na później, aby uniknąć parser-blocking via document.write
                html = html.replace(/<script\s+src="https:\/\/cdn\.jsdelivr\.net\/npm\/qrcodejs\/qrcode\.min\.js"[^>]*><\/script>/gi,
                    '<script data-mobile-defer-src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"><\\/script>');
                html = html.replace(/<script\s+src="https:\/\/cdn\.emailjs\.com\/dist\/email\.min\.js"[^>]*><\/script>/gi,
                    '<script data-mobile-defer-src="https://cdn.emailjs.com/dist/email.min.js"><\\/script>');
                // Zabezpiecz emailjs.init tak, aby poczekał na bibliotekę
                html = html.replace(/emailjs\.init\(([^)]*)\);/i,
                    '(function initEmail(){ if (window.emailjs&&emailjs.init){ try{ emailjs.init($1); }catch(_){ } } else { setTimeout(initEmail,200); } })();');

                                                // 2d) Wstrzyknij skrypt mobilny: tekst loadera, opóźniona podpowiedź, auto-refresh i doładowanie CDN
                        const mobileHelperScript = `
                            <script>(function(){
                                document.addEventListener('DOMContentLoaded', function(){
                                    try {
                                        var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || (navigator.platform==='MacIntel' && navigator.maxTouchPoints>1);
                                        if (!isMobile) return;
                                        // Uaktualnij tekst głównego loadera
                                        var lt = document.querySelector('#custom-loader .loading-text');
                                        if (lt) { lt.textContent = 'Inicjalizacja konfiguratora – ładowanie wersji mobilnej…'; }
                                        // Pokaż delikatną sugestię dopiero po dłuższym czasie
                                        function showHint(){
                                            var loader = document.getElementById('custom-loader');
                                            if (!loader || loader.style.display==='none') return;
                                            if (document.getElementById('mobile-longload-hint')) return;
                                            var hint = document.createElement('div');
                                            hint.id = 'mobile-longload-hint';
                                            hint.style.cssText = 'margin-top:12px;font-size:14px;color:#666;text-align:center;max-width:320px;';
                                            hint.textContent = 'Ładowanie trwa dłużej niż zwykle. Odśwież stronę.';
                                            try { loader.appendChild(hint); } catch(_){}
                                        }
                                        setTimeout(showHint, 8000);

                                        // Automatyczne odświeżenie po dłuższym czasie, jeśli główny loader nadal widoczny
                                        function maybeAutoReload(){
                                            try {
                                                var loader = document.getElementById('custom-loader');
                                                if (!loader || loader.style.display==='none') return; // załadowało
                                                if (sessionStorage.getItem('mobileReloadedOnce')==='1') return; // unikaj pętli
                                                sessionStorage.setItem('mobileReloadedOnce','1');
                                                var url = new URL(location.href);
                                                url.searchParams.set('r', Date.now().toString());
                                                location.replace(url.toString());
                                            } catch(_) { location.reload(); }
                                        }
                                        setTimeout(maybeAutoReload, 20000);

                                                                                // Doładuj odłożone CDN-y w tle (bez blokowania parsera)
                                                                                try {
                                                                                    var placeholders = document.querySelectorAll('script[data-mobile-defer-src]');
                                                                                    placeholders.forEach(function(ph){
                                                                                        var s = document.createElement('script');
                                                                                        s.src = ph.getAttribute('data-mobile-defer-src');
                                                                                        s.defer = true;
                                                                                        (ph.parentNode || document.head || document.documentElement).insertBefore(s, ph);
                                                                                        ph.parentNode && ph.parentNode.removeChild(ph);
                                                                                    });
                                                                                } catch(_){ }
                                    } catch(_){}
                                });
                            })();<\\/script>`;
                        if (html.includes('</head>')) {
                            html = html.replace(/<\/head>/i, mobileHelperScript + '\n</head>');
                        } else {
                            html = mobileHelperScript + html;
                        }

                        // 3) Delikatny sygnał do aplikacji, że to wariant mobile
                //    (nie zmieniamy logiki index.html – tylko podpowiedź)
                html = html.replace(/<body([^>]*)>/i, function(_, attrs){
                    return '<body'+ (attrs||'') + ' class="mobile-mode">';
                });

                // 4) Podmień cały dokument – uruchomi to oryginalne skrypty w trybie shim
                document.open();
                document.write(html);
                document.close();
            } catch (e) {
                console.error('Mobile loader failed:', e);
                showError('Nie udało się wczytać aplikacji mobilnej.');
            }
        })();
    </script>
</body>
</html>

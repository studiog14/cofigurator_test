<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="format-detection" content="telephone=no" />
    <title>Konfigurator krzeseł – Mobile</title>
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="icons/favicon.png" />
    <link rel="icon" href="favicon.png" />
    <style>
        html,body{height:100%;margin:0}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:#fff;color:#222}
        .loader{display:flex;align-items:center;justify-content:center;flex-direction:column;height:100vh;gap:12px}
        .spinner{width:40px;height:40px;border:3px solid #eee;border-top:3px solid #333;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .muted{color:#666;font-size:14px}
        .error{color:#b00020}
    </style>
    <script>
        (function(){
            // Minimal mobile-mode hint for CSS before app scripts run
            document.addEventListener('DOMContentLoaded', function(){
                                try {
                                    // Jeśli to nie jest urządzenie mobilne, przełącz na wersję desktop bez dotykania index.html
                                    var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || (navigator.platform==='MacIntel' && navigator.maxTouchPoints>1);
                                    if (!isMobile) { try { window.location.replace('index.html'); return; } catch(_) {} }
                                    document.body.classList.add('mobile-mode');
                                } catch(_) {}
            });
        })();
    </script>
</head>
<body>
        <div id="boot-loader" class="loader">
            <div class="spinner" aria-hidden="true"></div>
            <div id="boot-msg">Inicjalizacja konfiguratora w wersji mobilnej</div>
            <div id="boot-hint" class="muted" style="display:none">Strona ładuje się zbyt długo... Odśwież przeglądarkę/stronę</div>
        </div>

    <script>
        (async function(){
            console.log('[mobile.html] bootstrap start');
            const bootContainer = document.getElementById('boot-loader');
            function showError(msg){
                if(bootContainer){
                    bootContainer.innerHTML = '<div class="error">'+ (msg||'Błąd ładowania') +'</div>' +
                        '<div class="muted">Spróbuj ponownie, lub otwórz wersję standardową: <a href="index.html">index.html</a></div>';
                }
            }

            // Hard reset cache/storage on mobile (one-time per tab) before loading the app
            try {
                const HR_FLAG = 'MOBILE_HARD_RESET_DONE_v1';
                const alreadyDone = (window.name === HR_FLAG);
                if (!alreadyDone) {
                    try { var m = document.getElementById('boot-msg'); if (m) m.textContent = 'Czyszczenie pamięci podręcznej aplikacji…'; } catch(_){ }
                    // Unregister all service workers
                    try {
                        if ('serviceWorker' in navigator && navigator.serviceWorker.getRegistrations) {
                            const regs = await navigator.serviceWorker.getRegistrations();
                            await Promise.all(regs.map(r => r && r.unregister ? r.unregister().catch(()=>{}) : Promise.resolve()));
                        }
                    } catch(_){ }
                    // Delete all caches
                    try {
                        if (window.caches && caches.keys) {
                            const keys = await caches.keys();
                            await Promise.all(keys.map(k => caches.delete(k).catch(()=>{})));
                        }
                    } catch(_){ }
                    // Clear IndexedDB databases when possible
                    try {
                        if (window.indexedDB) {
                            // Modern browsers expose indexedDB.databases(); iOS 15 may not. Try/catch each delete.
                            if (indexedDB.databases) {
                                const dbs = await indexedDB.databases();
                                await Promise.all((dbs||[]).map(db => {
                                    if (!db || !db.name) return Promise.resolve();
                                    return new Promise(res => {
                                        try {
                                            const req = indexedDB.deleteDatabase(db.name);
                                            req.onsuccess = req.onerror = req.onblocked = () => res();
                                        } catch(_) { res(); }
                                    });
                                }));
                            }
                        }
                    } catch(_){ }
                    // Clear Web Storage (best-effort)
                    try { localStorage.clear(); } catch(_){ }
                    try { sessionStorage.clear(); } catch(_){ }

                    // Guard and reload with cache-busting param
                    try { window.name = HR_FLAG; } catch(_){ }
                    try {
                        const u = new URL(location.href);
                        u.searchParams.set('hr', Date.now().toString());
                        location.replace(u.toString());
                    } catch(_) { location.reload(); }
                    return; // Stop bootstrap; it will continue after reload
                } else {
                    // Clean the guard so it doesn't leak
                    try { window.name = ''; } catch(_){ }
                }
            } catch(_){ }

            // Safety: show hint after 8s and one-time auto-reload after 25s even if fetch stalls
            try {
                setTimeout(function(){ var h=document.getElementById('boot-hint'); if(h) h.style.display='block'; },8000);
                setTimeout(function(){
                    if (sessionStorage.getItem('mobileReloadedOnce')==='1') return;
                    sessionStorage.setItem('mobileReloadedOnce','1');
                    try { var u=new URL(location.href); u.searchParams.set('r', Date.now().toString()); location.replace(u.toString()); }
                    catch(_) { location.reload(); }
                },25000);
            } catch(_){ }

            try {
                // Pobierz źródło index.html i przygotuj wersję z shimami dla iOS
                const res = await fetch('index.html', { credentials: 'same-origin', cache: 'no-store' });
                if(!res.ok){ throw new Error('HTTP '+res.status); }
                let html = await res.text();

                    // Prosty transpiler usuwający optional chaining / nullish coalescing w inline module script
                    function transpileLight(src){
                        // iOS 15 wspiera optional chaining; unikamy ryzykownych podmian regex.
                        return src;
                    }

                // 1) Wstrzyknij es-module-shims w <head> (lub zaraz po <meta charset>)
                const shimTag = '<script async src="https://cdn.jsdelivr.net/npm/es-module-shims@1/dist/es-module-shims.min.js"></' + 'script>';
                const hintCss = '<style id="mobile-hint-style">\
@keyframes mobileHint{to{opacity:1}}\
/* Active category state on mobile same as desktop */\
body.mobile-mode .category-button.active{background:#F5C842;color:#fff;border-color:#F5C842}\
/* Ensure right panel is wide enough for 2 tiles */\
body.mobile-mode #mobile-right-panel{width:clamp(260px,38vw,360px);max-width:clamp(260px,38vw,360px)}\
/* Categories: two per row without changing button look */\
body.mobile-mode #mobile-category-buttons-container,\
body.mobile-mode #category-buttons-container{display:grid;grid-template-columns:1fr 1fr;gap:8px}\
/* Model thumbnails: two columns inside right panel */\
body.mobile-mode #mobile-right-panel #model-thumbnails,\
body.mobile-mode #mobile-right-panel .options-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}\
body.mobile-mode #mobile-right-panel .thumbnail-wrapper{width:100%}\
body.mobile-mode #mobile-right-panel .thumbnail{width:100%} \
body.mobile-mode #mobile-right-panel .thumbnail img{width:100%;height:auto;max-height:100px;object-fit:contain}\
</style>';
                if(html.includes('</head>')){
                    html = html.replace(/<head[^>]*>/i, function(m){ return m + '\n  ' + shimTag + '\n  ' + hintCss + '\n'; });
                } else {
                    // awaryjnie dodaj na początku
                    html = shimTag + '\n' + hintCss + '\n' + html;
                }

                // 2) Konwersja import map i modułów na wariant shim
                html = html
                    .replace(/type="importmap"/g, 'type="importmap-shim"')
                    .replace(/type="module"/g, 'type="module-shim"');

                    // 2b) Przetranskrybuj inline module-shim scripts (bez dotykania zewnętrznych plików)
                    html = html.replace(/<script([^>]*type=\"module-shim\"[^>]*)>([\s\S]*?)<\/script>/gi, function(_, attrs, code){
                        try {
                        let patched = transpileLight(code);
                        // Dodatkowe mobilne gardy na brakujące elementy DOM
                        patched = patched.replace(/buyButton\.addEventListener\(/g, 'buyButton && buyButton.addEventListener(');
                        patched = patched.replace(/closeBtn\.addEventListener\(/g, 'closeBtn && closeBtn.addEventListener(');
                        patched = patched.replace(/emailModal\.addEventListener\(/g, 'emailModal && emailModal.addEventListener(');
                        patched = patched.replace(/emailForm\.addEventListener\(/g, 'emailForm && emailForm.addEventListener(');
                        // Po inic Viewer: jeśli wybrano model przed inicjalizacją, załaduj go automatycznie
                        patched = patched.replace(/window\\.viewer\s*\=\s*viewer\s*;/, function(m){ return m + "\ntry{ if(window.__pendingMobileVariant){ loadModel(window.__pendingMobileVariant); window.__pendingMobileVariant=null; } }catch(_){}\n"; });
                            return '<script'+attrs+'>'+patched+'<\/script>';
                        } catch(e) {
                            return '<script'+attrs+'>'+code+'<\/script>';
                        }
                    });

                // 2c) Odłóż ładowanie zewnętrznych CDN scriptów na później, aby uniknąć parser-blocking via document.write
                html = html.replace(/<script\s+src="https:\/\/cdn\.jsdelivr\.net\/npm\/qrcodejs\/qrcode\.min\.js"[^>]*><\/script>/gi,
                    '<script data-mobile-defer-src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"><\\/script>');
                html = html.replace(/<script\s+src="https:\/\/cdn\.emailjs\.com\/dist\/email\.min\.js"[^>]*><\/script>/gi,
                    '<script data-mobile-defer-src="https://cdn.emailjs.com/dist/email.min.js"><\\/script>');
                // Zabezpiecz emailjs.init tak, aby poczekał na bibliotekę
                html = html.replace(/emailjs\.init\(([^)]*)\);/i,
                    '(function initEmail(){ if (window.emailjs&&emailjs.init){ try{ emailjs.init($1); }catch(_){ } } else { setTimeout(initEmail,200); } })();');

                    // 2d) Zmień komunikat loadera i wstrzyknij wskazówkę (CSS-only reveal po 8s)
                    html = html.replace(/<div\s+class=\"loading-text\"([^>]*)>([\s\S]*?)<\/div>/i, function(_, attrs){
                        return '<div class="loading-text"'+attrs+'>Inicjalizacja konfiguratora w wersji mobilnej<\/div>' +
                               '<div id="mobile-longload-hint" style="margin-top:12px;font-size:14px;color:#666;text-align:center;max-width:320px;opacity:0;animation:mobileHint 0s linear 8s forwards">Strona ładuje się zbyt długo... Odśwież przeglądarkę/stronę<\/div>';
                    });

                    // 2e) Doładuj odłożone CDN-y po wstawieniu dokumentu – bez wstrzykiwania dodatkowych <script> w stringu

                        // 3) Delikatny sygnał do aplikacji, że to wariant mobile
                //    (nie zmieniamy logiki index.html – tylko podpowiedź)
                html = html.replace(/<body([^>]*)>/i, function(_, attrs){
                    return '<body'+ (attrs||'') + ' class="mobile-mode">';
                });

                                // 4) Podmień cały dokument – uruchomi to oryginalne skrypty w trybie shim
                document.open();
                document.write(html);
                document.close();

                                // 5) Po wstawieniu: doładuj odłożone CDN-y i ustaw mobilny komunikat loadera + hint i auto-refresh
                                try {
                                    // Doładuj skrypty CDN
                                    var placeholders = document.querySelectorAll('script[data-mobile-defer-src]');
                                    placeholders.forEach(function(ph){
                                        var s = document.createElement('script');
                                        s.src = ph.getAttribute('data-mobile-defer-src');
                                        s.defer = true;
                                        (ph.parentNode || document.head || document.documentElement).insertBefore(s, ph);
                                        ph.parentNode && ph.parentNode.removeChild(ph);
                                    });

                                    // Mobile-only: wrap loadModel to show/hide the model loader
                                    (function hookLoadModel(retries){
                                        try {
                                            if (typeof window.loadModel === 'function') {
                                                var __origLoadModel = window.loadModel;
                                                if (!__origLoadModel.__mobileWrapped) {
                                                    var wrapped = async function(variant){
                                                        try { var ml = document.getElementById('model-loader'); if (ml) ml.style.display = 'flex'; } catch(_){}
                                                        try { return await __origLoadModel.call(this, variant); }
                                                        finally { try { setTimeout(function(){ var ml2=document.getElementById('model-loader'); if(ml2) ml2.style.display='none'; }, 300); } catch(_){} }
                                                    };
                                                    wrapped.__mobileWrapped = true;
                                                    window.loadModel = wrapped;
                                                }
                                                return;
                                            }
                                        } catch(_) {}
                                        if (retries < 100) setTimeout(function(){ hookLoadModel(retries+1); }, 100);
                                    })(0);

                                    // Mobile category buttons: ensure active state mirrors desktop behavior
                                    (function attachCategoryActiveSync(retries){
                                        try {
                                            var container = document.getElementById('mobile-right-panel') || document.getElementById('mobile-category-buttons-container');
                                            if (container) {
                                                container.addEventListener('click', function(e){
                                                    var btn = e.target && e.target.closest && e.target.closest('.category-button');
                                                    if (!btn) return;
                                                    var cat = btn.dataset && (btn.dataset.category || btn.textContent && btn.textContent.trim());
                                                    try {
                                                        var scope = container.querySelectorAll('.category-button');
                                                        scope.forEach(function(b){ b.classList.remove('active'); });
                                                        btn.classList.add('active');
                                                    } catch(_){}
                                                    try {
                                                        if (typeof window.renderMobileRightPanelList === 'function' && cat) {
                                                            window.renderMobileRightPanelList(cat);
                                                        }
                                                    } catch(_){}
                                                }, { passive: true });
                                                return;
                                            }
                                        } catch(_) {}
                                        if (retries < 50) setTimeout(function(){ attachCategoryActiveSync(retries+1); }, 200);
                                    })(0);

                                    // Mobile click delegation fallback: trigger loadModel when thumbnail clicked even if original handler fails
                                    (function attachMobileThumbFallback(){
                                        document.addEventListener('click', function(ev){
                                            try {
                                                var t = ev.target;
                                                if (!t) return;
                                                var thumb = t.closest && t.closest('#mobile-right-panel .thumbnail, #model-thumbnails .thumbnail, .model-thumbnail');
                                                if (!thumb) return;
                                                // Try to resolve model from caption text
                                                var wrap = thumb.parentElement;
                                                var cap = wrap && wrap.querySelector && wrap.querySelector('.thumbnail-caption');
                                                var name = cap && cap.textContent ? cap.textContent.trim() : '';
                                                if (!name && thumb.getAttribute) name = thumb.getAttribute('data-name') || '';
                                                var norm = function(s){ try { return s.normalize('NFD').replace(/\p{Diacritic}/gu,'').trim(); } catch(_) { return (s||'').trim(); } };
                                                var strip = function(s){ try { return (typeof window.stripBrackets==='function') ? window.stripBrackets(s) : String(s||'').replace(/\s*\([^)]*\)\s*/g,'').trim(); } catch(_) { return s; } };
                                                var targetName = norm(strip(name));
                                                var pick = null;
                                                if (Array.isArray(window.allData)) {
                                                    for (var i=0;i<window.allData.length;i++){
                                                        var it = window.allData[i];
                                                        if (it && it.Typ==='model'){
                                                            var n = norm(strip(it.Nazwa||''));
                                                            if (n && n.toLowerCase()===targetName.toLowerCase()) { pick = it; break; }
                                                        }
                                                    }
                                                }
                                                if (pick && typeof window.loadModel==='function'){
                                                    var ml = document.getElementById('model-loader'); if (ml) ml.style.display='flex';
                                                    window.loadModel(pick);
                                                }
                                            } catch(_){}
                                        }, { passive: true });
                                    })();

                                    // Tekst loadera dla mobile
                                    var lt = document.querySelector('#custom-loader .loading-text');
                                    if (lt) { lt.textContent = 'Inicjalizacja konfiguratora w wersji mobilnej'; }

                                    // Hint po 8s, auto-refresh po 20s (jednorazowo)
                                    setTimeout(function(){
                                        var loader = document.getElementById('custom-loader');
                                        if (!loader || loader.style.display==='none' || document.getElementById('mobile-longload-hint')) return;
                                        var hint = document.createElement('div');
                                        hint.id = 'mobile-longload-hint';
                                        hint.style.cssText = 'margin-top:12px;font-size:14px;color:#666;text-align:center;max-width:320px;';
                                        hint.textContent = 'Strona ładuje się zbyt długo... Odśwież przeglądarkę/stronę';
                                        try { loader.appendChild(hint); } catch(_){}
                                    }, 8000);

                                    setTimeout(function(){
                                        var loader = document.getElementById('custom-loader');
                                        if (!loader || loader.style.display==='none') return;
                                        if (sessionStorage.getItem('mobileReloadedOnce')==='1') return;
                                        sessionStorage.setItem('mobileReloadedOnce','1');
                                        try {
                                            var url = new URL(location.href);
                                            url.searchParams.set('r', Date.now().toString());
                                            location.replace(url.toString());
                                        } catch(_) { location.reload(); }
                                    }, 20000);
                                } catch(_){ }
                                
                                // Persist two-column model grid after UI rerenders on mobile
                                try {
                    var rightPanel = document.getElementById('mobile-right-panel') || document.body;
                    var thumbsContainer = rightPanel.querySelector('#model-thumbnails') || rightPanel.querySelector('.options-grid');
                    if (thumbsContainer) {
                                        var mo = new MutationObserver(function(){
                                            try {
                        thumbsContainer.style.display = 'grid';
                        thumbsContainer.style.gridTemplateColumns = '1fr 1fr';
                        thumbsContainer.style.gap = '10px';
                                            } catch(_){}
                                        });
                    mo.observe(thumbsContainer, { childList: true, subtree: true });
                                    }
                                } catch(_){}
            } catch (e) {
                console.error('Mobile loader failed:', e);
                showError('Nie udało się wczytać aplikacji mobilnej.');
            }
        })();
    </script>
</body>
</html>
